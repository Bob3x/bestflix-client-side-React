name: Keep Site Awake

on:
    schedule:
        - cron: "0 0 * * *" # schedule: once per day at 00:00 UTC
    workflow_dispatch: {}

jobs:
    ping:
        runs-on: ubuntu-latest
        steps:
            - name: Ping public site (HEAD, fallback to GET)
              env:
                  SITE_URL: ${{ secrets.SITE_URL }}
              run: |
                  set -euo pipefail
                  URL="${SITE_URL}"
                  if [ -z "${URL}" ]; then
                    echo "SITE_URL is empty" >&2
                    exit 1
                  fi
                  echo "Pinging ${URL} (HEAD, follow redirects)"
                  HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I -L "${URL}")
                  echo "HEAD status: ${HTTP_STATUS}"
                  # If HEAD returns 000 (connection issue) or >=400 or 405 (method not allowed), try GET
                  if [ "${HTTP_STATUS}" = "000" ] || [ "${HTTP_STATUS}" -ge 400 ] || [ "${HTTP_STATUS}" = "405" ]; then
                    echo "HEAD failed or not allowed. Trying GET..."
                    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L "${URL}")
                    echo "GET status: ${HTTP_STATUS}"
                  fi
                  if [ "${HTTP_STATUS}" -ge 400 ]; then
                    echo "Ping failed with status ${HTTP_STATUS}" >&2
                    exit 1
                  fi
                  echo "Ping successful (status ${HTTP_STATUS})"
